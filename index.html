<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¦¬ë“¬ê²Œì„ - ê°œë°œì ëª¨ë“œ í¬í•¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { --max-width: 900px; }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
      background: #000;
      color: #fff;
    }
    body { display: flex; flex-direction: column; align-items: center; padding: 16px; }

    h1 {
      margin: 12px 0 10px; line-height: 1.2; font-weight: 800;
      font-size: clamp(24px, 7vw, 40px); letter-spacing: -0.02em; text-align: center;
    }

    .bar {
      width: 100%; max-width: var(--max-width);
      display: flex; justify-content: center; gap: 12px;
    }
    .bar.menu { flex-wrap: nowrap; }
    .bar.menu > button { flex: 1 1 0; min-width: 0; }

    button {
      font-size: clamp(16px, 4.5vw, 18px);
      padding: 14px 18px; min-height: 48px;
      border-radius: 12px; border: 1px solid #2a2a2a; background:#0b0b0b; color:#fff;
      box-shadow: 0 1px 0 rgba(255,255,255,0.06); cursor: pointer;
    }
    button:active { transform: translateY(1px); }

    #content { width: 100%; max-width: var(--max-width); margin-top: 12px; }

    .input-row { display:flex; align-items:center; justify-content:center; gap:10px; margin: 10px 0; }
    label { font-size: clamp(15px, 4.2vw, 17px); }
    input[type="text"] {
      font-size: clamp(16px, 4.8vw, 18px);
      padding: 12px 14px; min-height: 48px;
      width: min(420px, 80vw);
      border: 1.2px solid #3a3a3a; border-radius: 10px; background: #111; color:#fff;
    }

    p { margin: 10px 0; font-size: clamp(15px, 4.2vw, 17px); text-align:center; }

    canvas {
      width: 100%; max-height: 70vh;
      display: block; margin: 0 auto; border: 1px solid #222;
      touch-action: manipulation; background: transparent;
    }

    /* ë°°ì¹˜ ëª¨ë“œ ë ˆì´ì•„ì›ƒ */
    .dev-wrap { display:flex; gap:12px; align-items:flex-start; }
    .canvas-col { flex: 2 1 0; }
    .panel-col  { flex: 1 1 280px; border:1px solid #222; border-radius:12px; padding:10px; background:#0b0b0b; }
    .panel-col h3 { margin: 0 0 8px; font-size: 16px; }
    .panel-col .actions { display:flex; gap:8px; margin:8px 0 6px; }
    .panel-col textarea {
      width: 100%; height: 52vh;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px; line-height: 1.5;
      background: #0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:10px;
      padding:10px; resize: vertical;
    }
    .hint { color:#bbb; font-size:12px; margin-top:6px; }

    @media (max-width: 900px) {
      .dev-wrap { flex-direction: column; }
      .panel-col textarea { height: 30vh; }
    }
  </style>
</head>
<body>
  <h1>ğŸµ ë¦¬ë“¬ê²Œì„ ğŸµ</h1>

  <div class="bar menu">
    <button onclick="enterPlacementMode()">íƒ€ì¼ ë°°ì¹˜</button>
    <button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    <button onclick="showRanking()">ë­í‚¹ í™•ì¸</button>
  </div>

  <div id="content"></div>

  <script>
    // ====== ì „ì—­ ìƒíƒœ ======
    let gameArea, ctx;
    let score = 0;
    let circles = [];
    let gameStartAt = 0;
    let loopStarted = false;

    // ê°œë°œì ë°°ì¹˜ ëª¨ë“œ
    let devMode = false;
    let placements = [];  // {x, y, t}
    let activeTimers = [];
    let showGhost = false;
    const mouse = { x: 300, y: 200 };

    // ë…¼ë¦¬ ì¢Œí‘œ(ë””ìì¸ í•´ìƒë„)
    const DESIGN_W = 600;
    const DESIGN_H = 400;

    // íŒì • ìƒìˆ˜ (ì ˆë°˜ ì„¸íŒ…)
    const TARGET = 35;      // í¼í™íŠ¸ ê¸°ì¤€ ë°˜ì§€ë¦„
    const PERFECT_MIN = 30; // í¼í™íŠ¸ í•˜í•œ
    const PERFECT_MAX = 40; // í¼í™íŠ¸ ìƒí•œ

    // í„°ì¹˜ íˆíŠ¸ë°•ìŠ¤ (ë…¼ë¦¬ ì¢Œí‘œ ê¸°ì¤€)
    const TOUCH_HIT_RADIUS = 33;

    // ===== BGM =====
    let bgm;
    const BGM_SRC = "assets/Halloween_Night.mp3";

    // ===== ë…¸íŠ¸/í¼í™íŠ¸ ì´ë¯¸ì§€ =====
    const imgNote = new Image();
    imgNote.crossOrigin = "anonymous";
    imgNote.src = "assets/note.png";

    const imgPerfect = new Image();
    imgPerfect.crossOrigin = "anonymous";
    imgPerfect.src = "assets/perfect.png";

    // ===== ë°°ê²½ ë ˆì´ì–´ ===== (v3 ì‚¬ìš© ì˜ˆì‹œ)
    const bgSky    = new Image(); bgSky.src    = "assets/bg_sky.png";
    const bgFar    = new Image(); bgFar.src    = "assets/bg_forest_far_v3.png";
    const bgNear   = new Image(); bgNear.src   = "assets/bg_forest_near_v3.png";
    const bgBlack  = new Image(); bgBlack.src  = "assets/bg_forest_black_v3.png";

    // ìŠ¤í¬ë¡¤ ì˜¤í”„ì…‹ê³¼ ì†ë„ (ì˜¤ë¥¸ìª½ ì´ë™)
    let bgOff = { sky: 0, far: 0, near: 0, black: 0 };
    const BG_SPEED = { sky: 0.2, far: 0.6, near: 1.0, black: 1.6 };

    // ë·°(ìŠ¤í¬ë¦° ìŠ¤ì¼€ì¼/ì˜¤í”„ì…‹) ìƒíƒœ
    const view = { cssW:0, cssH:0, dpr:1, scale:1, offsetX:0, offsetY:0 };

    // ====== í”„ë ˆì„ ë…ë¦½ ì„±ì¥ ì†ë„ ======
    let lastTime = 0;
    const GROWTH_PER_SEC = 18; // 1ì´ˆì— ë°˜ì§€ë¦„ 18 ì¦ê°€ (60fpsì—ì„œ 0.3/frameê³¼ ë™ì¼)

    // ====== ìœ í‹¸ ======
    function getPlayTimeMs() { return devMode ? 0 : (performance.now() - gameStartAt); }

    function sortPlacements() { placements.sort((a,b)=>a.t - b.t); }

    function generateCodeText() {
      sortPlacements();
      return placements.map(p => `setTimeout(() => createCircle(${p.x}, ${p.y}), ${p.t});`).join("\n");
    }

    function copyCode() {
      const ta = document.getElementById("codeList");
      if (!ta) return;
      ta.select();
      document.execCommand("copy");
    }

    // ====== ë¦¬ì‚¬ì´ì¦ˆ & ìŠ¤ì¼€ì¼ë§ ======
    function resizeCanvas() {
      if (!gameArea || !ctx) return;

      const container = gameArea.parentElement;
      const containerW = container.clientWidth;
      const aspect = DESIGN_H / DESIGN_W; // 400/600
      let cssW = containerW;
      let cssH = Math.round(cssW * aspect);

      const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
      const maxH = (window.innerWidth < 768) ? Math.round(vh * 0.70) : Math.round(vh * 0.60);
      if (cssH > maxH) { cssH = maxH; cssW = Math.round(cssH / aspect); }

      view.cssW = cssW; view.cssH = cssH;

      const dpr = window.devicePixelRatio || 1;
      view.dpr = dpr;
      gameArea.style.width = cssW + "px";
      gameArea.style.height = cssH + "px";
      gameArea.width = Math.round(cssW * dpr);
      gameArea.height = Math.round(cssH * dpr);

      const scaleX = cssW / DESIGN_W;
      const scaleY = cssH / DESIGN_H;
      view.scale = Math.min(scaleX, scaleY);
      view.offsetX = (cssW - DESIGN_W * view.scale) / 2;
      view.offsetY = (cssH - DESIGN_H * view.scale) / 2;

      applyViewTransform();
    }

    function applyViewTransform() {
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.setTransform(view.scale * view.dpr, 0, 0, view.scale * view.dpr,
                       view.offsetX * view.dpr, view.offsetY * view.dpr);
    }

    function clearFrame() {
      ctx.save();
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, gameArea.width, gameArea.height);
      ctx.restore();
      applyViewTransform();
    }

    // ===== ë°°ê²½ ê·¸ë¦¬ê¸° =====
    function drawTiled(img, ox, oy) {
      if (!img.complete || img.naturalWidth === 0) return;
      const iw = img.naturalWidth, ih = img.naturalHeight;

      const scale = DESIGN_H / ih;
      const drawW = Math.ceil(iw * scale);
      const drawH = Math.ceil(ih * scale);

      let startX = - (ox % drawW);
      if (startX > 0) startX -= drawW;

      for (let x = startX; x < DESIGN_W; x += drawW) {
        ctx.drawImage(img, x, oy + (DESIGN_H - drawH), drawW, drawH);
      }
    }

    function updateBackground() {
      bgOff.sky  += BG_SPEED.sky;
      bgOff.far  += BG_SPEED.far;
      bgOff.near += BG_SPEED.near;
      bgOff.black+= BG_SPEED.black;

      drawTiled(bgSky,   bgOff.sky,   0);
      drawTiled(bgFar,   bgOff.far,   0);
      drawTiled(bgNear,  bgOff.near,  0);
      drawTiled(bgBlack, bgOff.black, 0);
    }

    // ====== ê³µìš© íŒì • ì²˜ë¦¬ ======
    function attemptHitOn(index) {
      if (index < 0 || index >= circles.length) return;
      const c = circles[index];
      const r = c.radius;
      let gained = 0;

      if (r > PERFECT_MIN && r < PERFECT_MAX) {
        gained = 100;
      } else if (Math.abs(r - TARGET) < 25) {
        gained = 50;
      } else {
        gained = 10;
      }

      score += gained;
      const el = document.getElementById("score");
      if (el) el.innerText = score;
      circles.splice(index, 1);
    }

    // ====== ì…ë ¥: í‚¤ë³´ë“œ(ê²Œì„ìš©) ======
    function onKeyDown(e) {
      if (devMode) return; // ë°°ì¹˜ëª¨ë“œì—ì„œëŠ” Space íŒì • ë¹„í™œì„±
      if (e.code !== "Space") return;
      if (circles.length === 0) return;
      attemptHitOn(0);
    }

    // ====== ì…ë ¥: í„°ì¹˜/í´ë¦­(ê²Œì„ìš©) ======
    function screenToLogical(clientX, clientY) {
      const rect = gameArea.getBoundingClientRect();
      const cssX = clientX - rect.left;
      const cssY = clientY - rect.top;
      const x = (cssX - view.offsetX) / view.scale;
      const y = (cssY - view.offsetY) / view.scale;
      return { x, y };
    }

    function onPointerDown(e) {
      if (devMode) return; // ë°°ì¹˜ëª¨ë“œ í´ë¦­ì€ ë³„ë„ í•¸ë“¤ëŸ¬ ì‚¬ìš©
      const { x, y } = screenToLogical(e.clientX, e.clientY);

      // í„°ì¹˜ ì§€ì ì—ì„œ ê°€ê¹Œìš´ ì› ì°¾ê¸°
      let bestIdx = -1;
      let bestDist = Infinity;
      circles.forEach((c, i) => {
        const dx = x - c.x, dy = y - c.y;
        const dist = Math.hypot(dx, dy);
        if (dist <= TOUCH_HIT_RADIUS && dist < bestDist) {
          bestDist = dist;
          bestIdx = i;
        }
      });

      if (bestIdx !== -1) attemptHitOn(bestIdx);
    }

    // ====== ë°°ì¹˜ëª¨ë“œ í•¸ë“¤ëŸ¬ ======
    function devKeyDown(e) {
      if (!devMode) return;
      if (e.code === "KeyK") showGhost = true;
    }
    function devKeyUp(e) {
      if (!devMode) return;
      if (e.code === "KeyK") showGhost = false;
    }
    function onDevPointerMove(e) {
      if (!devMode) return;
      const { x, y } = screenToLogical(e.clientX, e.clientY);
      mouse.x = Math.round(x);
      mouse.y = Math.round(y);
    }
    function onDevPointerDown(e) {
      if (!devMode) return;
      if (!showGhost) return; // Kí‚¤ë¥¼ ëˆ„ë¥¸ ìƒíƒœì—ì„œë§Œ ë°°ì¹˜
      const { x, y } = screenToLogical(e.clientX, e.clientY);
      placements.push({ x: Math.round(x), y: Math.round(y), t: 99999 });
      sortPlacements();
      refreshCodePanel();
    }

    // ====== ê²Œì„ ë£¨í”„ ======
    function updateGame() {
      // dt ê³„ì‚° (í”„ë ˆì„ ë…ë¦½)
      const now = performance.now();
      const dt = lastTime ? (now - lastTime) / 1000 : 0;
      lastTime = now;

      if (!ctx) { requestAnimationFrame(updateGame); return; }

      clearFrame();

      // ì„ /í°íŠ¸ ë³´ì • ë¨¼ì €
      const lw = 1 / view.scale;
      ctx.lineWidth = lw;
      ctx.font = `${Math.max(10, Math.floor(12 / view.scale))}px sans-serif`;

      // ë°°ê²½
      updateBackground();

      // ìš°ì¸¡ ìƒë‹¨ í”Œë ˆì´íƒ€ì„
      ctx.save();
      ctx.setLineDash([]);
      ctx.fillStyle = "#fff";
      ctx.textAlign = "right";
      ctx.textBaseline = "top";
      const tSec = (getPlayTimeMs() / 1000).toFixed(2);
      ctx.fillText(`t=${tSec}s`, DESIGN_W - 8, 6);
      ctx.restore();

      // ë…¸íŠ¸/í¼í™íŠ¸ ì—…ë°ì´íŠ¸ & ë Œë” (ê²Œì„ ëª¨ë“œì¼ ë•Œë§Œ ì›ì´ ì»¤ì§)
      if (!devMode) {
        circles.forEach(c => {
          // í”„ë ˆì„ë ˆì´íŠ¸ ë¬´ê´€ ì¼ì • ì†ë„
          c.radius += GROWTH_PER_SEC * dt;

          const size = c.radius * 2;
          if (imgNote.complete && imgNote.naturalWidth > 0) {
            ctx.imageSmoothingEnabled = true;
            ctx.drawImage(imgNote, c.x - c.radius, c.y - c.radius, size, size);
          } else {
            ctx.beginPath();
            ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
            ctx.strokeStyle = "#ddd";
            ctx.stroke();
          }

          // ë°˜ì§€ë¦„ í…ìŠ¤íŠ¸(ì˜µì…˜)
          ctx.fillStyle = "#fff";
          ctx.fillText("r=" + Math.floor(c.radius), c.x + c.radius + 3, c.y);

          // í¼í™íŠ¸ ê¸°ì¤€ ë§
          const pSize = TARGET * 2;
          if (imgPerfect.complete && imgPerfect.naturalWidth > 0) {
            ctx.drawImage(imgPerfect, c.x - TARGET, c.y - TARGET, pSize, pSize);
          } else {
            ctx.setLineDash([10 / view.scale, 7 / view.scale]);
            ctx.strokeStyle = "red";
            ctx.beginPath();
            ctx.arc(c.x, c.y, TARGET, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);
          }
        });

        // rê°€ ë„ˆë¬´ ì»¤ì§„ ì› ì œê±° (60 ì´ˆê³¼ ì œê±°)
        circles = circles.filter(c => c.radius <= 60);
      }

      // ë°°ì¹˜ëª¨ë“œ: Kí‚¤ ë¯¸ë¦¬ë³´ê¸°
      if (devMode && showGhost) {
        const r = 5;
        const size = r * 2;
        ctx.save();
        ctx.globalAlpha = 0.8;
        if (imgNote.complete && imgNote.naturalWidth > 0) {
          ctx.drawImage(imgNote, mouse.x - r, mouse.y - r, size, size);
        } else {
          ctx.beginPath();
          ctx.arc(mouse.x, mouse.y, r, 0, Math.PI * 2);
          ctx.strokeStyle = "#77ff77";
          ctx.stroke();
        }
        // í¼í™íŠ¸ ê¸°ì¤€ ë§ ë¯¸ë¦¬ë³´ê¸°(ì˜µì…˜)
        ctx.globalAlpha = 0.6;
        const p = TARGET * 2;
        if (imgPerfect.complete && imgPerfect.naturalWidth > 0) {
          ctx.drawImage(imgPerfect, mouse.x - TARGET, mouse.y - TARGET, p, p);
        }
        ctx.restore();
      }

      requestAnimationFrame(updateGame);
    }

    // ====== í™”ë©´ êµ¬ì„± ======
    function startGame() {
      document.getElementById("content").innerHTML = `
        <div class="input-row">
          <label for="studentId">í•™ë²ˆ</label>
          <input id="studentId" type="text" placeholder="ì˜ˆ) 30123">
        </div>
        <div class="input-row">
          <label for="name">ì´ë¦„</label>
          <input id="name" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="bar">
          <button onclick="gameStart()">ì…ë ¥ ì™„ë£Œ</button>
        </div>
      `;
    }

    function gameStart() {
      const id = (document.getElementById("studentId").value || "").trim();
      const name = (document.getElementById("name").value || "").trim();

      document.getElementById("content").innerHTML = `
        <canvas id="gameCanvas"></canvas>
        <p>ì ìˆ˜: <span id="score">0</span></p>
        <p>${id} ${name} ë‹˜, ì›í•˜ëŠ” íƒ€ì´ë°ì— ìŠ¤í° í•¨ìˆ˜ë¡œ ì›ì„ ìƒì„±í•˜ì„¸ìš”.
           (ëª¨ë°”ì¼: í„°ì¹˜ ê·¼ì²˜ ì› íŒì • / PC: Space)</p>
      `;

      devMode = false;  // ê²Œì„ ëª¨ë“œ

      gameArea = document.getElementById("gameCanvas");
      ctx = gameArea.getContext("2d");

      resizeCanvas();

      // ë£¨í”„ëŠ” 1íšŒë§Œ ì‹œì‘
      if (!loopStarted) { loopStarted = true; requestAnimationFrame(updateGame); }

      // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ í›„ ê²Œì„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      document.removeEventListener("keydown", devKeyDown);
      document.removeEventListener("keyup", devKeyUp);
      if (gameArea) {
        gameArea.removeEventListener("pointermove", onDevPointerMove);
        gameArea.removeEventListener("pointerdown", onDevPointerDown);
      }
      document.addEventListener("keydown", onKeyDown, { passive: true });
      gameArea.addEventListener("pointerdown", onPointerDown, { passive: true });

      window.addEventListener("resize", resizeCanvas);
      window.addEventListener("orientationchange", () => setTimeout(resizeCanvas, 50));

      // BGM ì¬ìƒ
      try {
        bgm = new Audio(BGM_SRC);
        bgm.loop = true;
        bgm.volume = 0.8;
        bgm.currentTime = 0;
        bgm.play().catch(() => {
          const unlock = () => {
            bgm.play().finally(() => gameArea.removeEventListener("pointerdown", unlock));
          };
          gameArea.addEventListener("pointerdown", unlock, { once: true });
        });
      } catch (e) { console.warn("BGM ì¬ìƒ ì‹¤íŒ¨:", e); }

      // ì´ì „ íƒ€ì´ë¨¸ ì •ë¦¬
      activeTimers.forEach(id => clearTimeout(id));
      activeTimers = [];
      circles = [];

      // ë°°ì¹˜ ëª©ë¡ëŒ€ë¡œ ìŠ¤ì¼€ì¤„ë§
      sortPlacements();
      placements.forEach(p => {
        const id = setTimeout(() => createCircle(p.x, p.y), p.t);
        activeTimers.push(id);
      });

      // íƒ­ ì „í™˜ ì‹œ ì¼ì‹œì •ì§€/ì¬ê°œ
      document.addEventListener("visibilitychange", () => {
        if (!bgm) return;
        if (document.hidden) bgm.pause();
        else bgm.play().catch(()=>{});
      });

      // í”Œë ˆì´íƒ€ì„ ì‹œì‘ & dt ì´ˆê¸°í™”
      gameStartAt = performance.now();
      lastTime = 0; // ì²« í”„ë ˆì„ dt ê³¼ë‹¤ ë°©ì§€
    }

    function enterPlacementMode() {
      // ë°°ì¹˜ ëª¨ë“œ UI
      document.getElementById("content").innerHTML = `
        <div class="dev-wrap">
          <div class="canvas-col"><canvas id="gameCanvas"></canvas></div>
          <div class="panel-col">
            <h3>ë°°ì¹˜ ì½”ë“œ (ì‹œê°„ìˆœ)</h3>
            <div class="actions">
              <button onclick="copyCode()">ì½”ë“œ ë³µì‚¬</button>
              <button onclick="placements=[]; refreshCodePanel();">ëª¨ë‘ ì‚­ì œ</button>
            </div>
            <textarea id="codeList" spellcheck="false"></textarea>
            <p class="hint">K í‚¤ ëˆ„ë¥´ê³  ì´ë™: ë¯¸ë¦¬ë³´ê¸° â€¢ í´ë¦­: ë°°ì¹˜ ì¶”ê°€ â€¢ ê¸°ë³¸ ì‹œê°„ 99999ms<br>
            ë¼ì¸ í¸ì§‘ ì‹œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤. ì˜ˆ) <code>setTimeout(() => createCircle(300, 200), 1500);</code></p>
          </div>
        </div>
      `;

      devMode = true;

      // BGM ì •ì§€
      try { if (bgm) bgm.pause(); } catch(e) {}

      gameArea = document.getElementById("gameCanvas");
      ctx = gameArea.getContext("2d");
      resizeCanvas();

      if (!loopStarted) { loopStarted = true; requestAnimationFrame(updateGame); }

      // ê²Œì„ ë¦¬ìŠ¤ë„ˆ ì œê±°, ë°°ì¹˜ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      document.removeEventListener("keydown", onKeyDown);
      if (gameArea) gameArea.removeEventListener("pointerdown", onPointerDown);
      document.addEventListener("keydown", devKeyDown, { passive: true });
      document.addEventListener("keyup", devKeyUp, { passive: true });
      gameArea.addEventListener("pointermove", onDevPointerMove, { passive: true });
      gameArea.addEventListener("pointerdown", onDevPointerDown, { passive: true });

      window.addEventListener("resize", resizeCanvas);
      window.addEventListener("orientationchange", () => setTimeout(resizeCanvas, 50));

      refreshCodePanel();

      // ì½”ë“œ í¸ì§‘ ì‹¤ì‹œê°„ ë°˜ì˜ (ë®ì–´ì“°ê¸° ë°©ì§€ ë²„ì „)
      const ta = document.getElementById("codeList");
      ta.addEventListener("input", onCodeInput);
      // í¬ì»¤ìŠ¤ê°€ ë¹ ì§ˆ ë•Œë§Œ ì •ë ¬ëœ í˜•ì‹ìœ¼ë¡œ ë˜ëŒë ¤ ì”€
      ta.addEventListener("blur", () => {
        updatingCodePanel = true;
        ta.value = generateCodeText();
        updatingCodePanel = false;
      });

      // dt ì´ˆê¸°í™”(ë°°ì¹˜ëª¨ë“œì—ì„  ì›ì´ ìë¼ì§€ ì•Šì§€ë§Œ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”)
      lastTime = 0;
    }

    let updatingCodePanel = false;
    function refreshCodePanel() {
      const ta = document.getElementById("codeList");
      if (!ta) return;
      updatingCodePanel = true;
      ta.value = generateCodeText();
      updatingCodePanel = false;
    }

    // âœ… ì…ë ¥ ì¤‘ ë®ì–´ì“°ê¸°/ì „ì²´ì‚­ì œ ë°©ì§€: ëª¨ë‘ ìœ íš¨í•  ë•Œë§Œ placements ê°±ì‹ 
    function onCodeInput(e) {
      if (updatingCodePanel) return;
      const lines = e.target.value split(/\r?\n/).map(s => s.trim());
      const re = /^setTimeout\(\s*\(\)\s*=>\s*createCircle\(\s*(\d+)\s*,\s*(\d+)\s*\)\s*,\s*(\d+)\s*\)\s*;?$/;

      const parsed = [];
      let allValid = true;

      for (const line of lines) {
        if (!line) continue;                  // ë¹ˆ ì¤„ì€ ìŠ¤í‚µ
        const m = line.match(re);
        if (!m) { allValid = false; break; }  // ë¯¸ì™„ì„±/ë¶ˆì¼ì¹˜ â†’ ë°˜ì˜ ë³´ë¥˜
        parsed.push({ x:+m[1], y:+m[2], t:+m[3] });
      }

      if (allValid) {
        placements = parsed;
        sortPlacements();
        // ì—¬ê¸°ì„œ refreshCodePanel() í˜¸ì¶œí•˜ì§€ ì•ŠìŒ (ë®ì–´ì“°ê¸° ê¸ˆì§€)
      }
    }

    // ====== ë°ì´í„° / API ======
    function createCircle(x = 300, y = 200) {
      circles.push({ x, y, radius: 5 }); // ì ˆë°˜ ì‹œì‘ ë°˜ì§€ë¦„
    }

    function showRanking() {
      document.getElementById("content").innerHTML = `<p>ë­í‚¹ ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •</p>`;
    }

    // ì´ˆê¸° ì•ˆë‚´
    document.getElementById("content").innerHTML = `
      <p>ì¢Œì¸¡ ìƒë‹¨ì˜ <b>íƒ€ì¼ ë°°ì¹˜</b>ë¡œ ë°°ì¹˜ ëª¨ë“œì— ë“¤ì–´ê°€ê±°ë‚˜, <b>ê²Œì„ ì‹œì‘</b>ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.</p>
    `;
  </script>
</body>
</html>
