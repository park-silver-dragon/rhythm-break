<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¦¬ë“¬ê²Œì„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { --max-width: 900px; }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
      background: #000;
      color: #fff;
    }
    body { display: flex; flex-direction: column; align-items: center; padding: 16px; }

    h1 {
      margin: 12px 0 10px; line-height: 1.2; font-weight: 900;
      font-size: clamp(24px, 7vw, 40px); letter-spacing: -0.02em; text-align: center;
    }

    .bar {
      width: 100%; max-width: var(--max-width);
      display: flex; justify-content: center; gap: 12px;
    }

    .bar.menu { flex-wrap: nowrap; }
    .bar.menu > button { flex: 1 1 0; min-width: 0; }

    button {
      font-size: clamp(16px, 4.5vw, 18px);
      padding: 14px 18px; min-height: 48px;
      border-radius: 12px; border: 1px solid #222; background:#0b0b0b;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06); cursor: pointer; color:#fff;
    }
    button:active { transform: translateY(1px); }

    #content { width: 100%; max-width: var(--max-width); margin-top: 12px; }

    .input-row { display:flex; align-items:center; justify-content:center; gap:10px; margin: 10px 0; }
    label { font-size: clamp(15px, 4.2vw, 17px); }
    input[type="text"] {
      font-size: clamp(16px, 4.8vw, 18px);
      padding: 12px 14px; min-height: 48px;
      width: min(420px, 80vw);
      border: 1.2px solid #222; border-radius: 10px; background: #0b0b0b; color:#fff;
    }

    p { margin: 10px 0; font-size: clamp(15px, 4.2vw, 17px); text-align:center; color:#ddd; }

    canvas {
      width: 100%; max-height: 85vh;
      display: block; margin: 0 auto; border: 1px solid #222;
      touch-action: manipulation; background: transparent;
    }

    /* ë°°ì¹˜ ëª¨ë“œ ë ˆì´ì•„ì›ƒ */
    .dev-wrap { display:flex; gap:12px; align-items:flex-start; }
    .canvas-col { flex: 2 1 0; }
    .panel-col  { flex: 1 1 280px; border:1px solid #222; border-radius:12px; padding:10px; background:#0b0b0b; }
    .panel-col h2 { margin: 6px 0 8px; font-size: 16px; }
    .panel-col small { color:#aaa; display:block; margin-bottom:8px; }
    textarea {
      width: 100%;
      height: 420px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background:#070707; color:#d7ffd7;
      border:1px solid #222; border-radius:10px; padding:10px;
    }

    .hint { font-size: 13px; color:#aaa; line-height: 1.35; }

    @media (min-width: 1024px) {
      button { padding: 12px 16px; }
      input[type="text"] { width: 420px; }
    }

    /* âœ… ê²Œì„/ë°°ì¹˜ ì¤‘ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    body.lock-scroll {
      position: fixed;
      left: 0;
      right: 0;
      width: 100%;
      overflow: hidden;
      touch-action: none;
    }
  </style>
</head>
<body>
  <h1>ğŸµ ë¦¬ë“¬ê²Œì„ ğŸµ</h1>

  <div class="bar menu">
    <button onclick="enterPlacementMode()">íƒ€ì¼ ë°°ì¹˜</button>
    <button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    <button onclick="showRanking()">ë­í‚¹ í™•ì¸</button>
  </div>

  <div id="content"></div>

  <!-- ğŸ”¥ Firebase / Firestore (ì ìˆ˜ ì €ì¥ìš© - ë‚˜ì¤‘ì— ì‚¬ìš©) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBxOnlL3ugTshph4CpWFSkE9BE-qgRgPlQ",
      authDomain: "rhythm-break.firebaseapp.com",
      projectId: "rhythm-break",
      storageBucket: "rhythm-break.firebasestorage.app",
      messagingSenderId: "355457273272",
      appId: "1:355457273272:web:04d5594b19c09add22534d",
      measurementId: "G-RTXSJM3DJN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function submitScore({ studentId, name, score, playTimeMs }) {
      await addDoc(collection(db, "scores"), {
        studentId, name, score, playTimeMs,
        createdAt: serverTimestamp()
      });
    }

    window.submitScore = submitScore;
  </script>

  <script>
    // ====== ì „ì—­ ìƒíƒœ ======
    let gameArea, ctx;
    let score = 0;
    let circles = [];

    // âœ… ìŠ¤í¬ë¡¤ ì ê¸ˆ/í•´ì œ
    let savedScrollY = 0;
    function lockScroll() {
      savedScrollY = window.scrollY || 0;
      document.body.classList.add("lock-scroll");
      document.body.style.top = `-${savedScrollY}px`;
    }
    function unlockScroll() {
      document.body.classList.remove("lock-scroll");
      const y = Math.abs(parseInt(document.body.style.top || "0", 10)) || 0;
      document.body.style.top = "";
      window.scrollTo(0, y);
    }

    // í”Œë ˆì´íƒ€ì„
    let gameStartAt = 0;
    function getPlayTimeMs() { return performance.now() - gameStartAt; }

    // ê°œë°œì ë°°ì¹˜ ëª¨ë“œ
    let devMode = false;
    let placements = [];  // {x, y, t} (tëŠ” beat)
    let activeTimers = [];
    let showGhost = false;

    // ë…¼ë¦¬ ì¢Œí‘œ(ë””ìì¸ í•´ìƒë„) â€” 9:16
    const DESIGN_W = 540;
    const DESIGN_H = 960;

    const CENTER_X = () => DESIGN_W / 2;
    const CENTER_Y = () => DESIGN_H / 2;

    // ë§ˆìš°ìŠ¤/ê³ ìŠ¤íŠ¸ ì´ˆê¸° ìœ„ì¹˜(ì¤‘ì•™)
    const mouse = { x: CENTER_X(), y: CENTER_Y() };

    // ===== ë°•ì(beat) ê¸°ë°˜ ë°°ì¹˜ =====
    const BPM = 140;
    const MS_PER_BEAT = 60000 / BPM; // 1 beat = 428.571...ms
    function beatToMs(beat) { return beat * MS_PER_BEAT; }
    function formatBeat(b) {
      if (Number.isInteger(b)) return String(b);
      return String(Number(b.toFixed(3)));
    }

    // ===== ë…¸íŠ¸ í¬ê¸°/ì†ë„ íŠœë‹ =====
    const NOTE_START_R = 10;
    const TARGET = 42;
    const PERFECT_WINDOW = 6;
    const PERFECT_MIN = TARGET - PERFECT_WINDOW;
    const PERFECT_MAX = TARGET + PERFECT_WINDOW;

    const TOUCH_HIT_RADIUS = 40;

    // í”„ë ˆì„ ë…ë¦½(ì‹œê°„ ê¸°ë°˜) ì„±ì¥
    let lastFrameAt = 0;
    const GROW_PER_SEC = 26;

    // ===== í¼í™íŠ¸ ë§ë§Œ 0.5ì´ˆ ë¨¼ì € ë³´ì—¬ì£¼ê¸° =====
    const PRE_RING_MS = 500;
    let prePerfectRings = []; // {x, y, until}
    function addPrePerfectRing(x, y) {
      prePerfectRings.push({ x, y, until: performance.now() + PRE_RING_MS });
    }
    function removePrePerfectRingAt(x, y) {
      prePerfectRings = prePerfectRings.filter(r => !(r.x === x && r.y === y));
    }

    // ===== BGM =====
    let bgm;
    const BGM_SRC = "assets/bgm_retro.mp3";

    // ===== COUNTDOWN TICK SFX (í‹± 1ê°œì§œë¦¬) =====
    // assets/kick.mp3 ë¡œ ë„£ì–´ì¤˜
    let sfxTick;
    const SFX_TICK_SRC = "assets/kick.mp3";

    function primeBgm() {
      try {
        if (!bgm) bgm = new Audio(BGM_SRC);
        bgm.loop = true;
        bgm.volume = 0.5;
        bgm.currentTime = 0;

        const p = bgm.play();
        if (p && typeof p.then === "function") {
          p.then(() => { bgm.pause(); bgm.currentTime = 0; }).catch(()=>{});
        }
      } catch(e) {}
    }

    function primeTick() {
      try {
        if (!sfxTick) sfxTick = new Audio(SFX_TICK_SRC);

        const prevVol = (typeof sfxTick.volume === "number") ? sfxTick.volume : 1.0;
        sfxTick.volume = 0;          // í”„ë¼ì„ ì¤‘ ë¬´ìŒ
        sfxTick.currentTime = 0;

        const p = sfxTick.play();
        if (p && typeof p.then === "function") {
          p.then(() => {
            sfxTick.pause();
            sfxTick.currentTime = 0;
            sfxTick.volume = prevVol || 1.0;
          }).catch(()=>{ sfxTick.volume = prevVol || 1.0; });
        } else {
          sfxTick.pause();
          sfxTick.currentTime = 0;
          sfxTick.volume = prevVol || 1.0;
        }
      } catch(e) {}
    }

    function playTick() {
      try {
        // ë¹ ë¥´ê²Œ ì—°íƒ€ë  ìˆ˜ ìˆì–´ì„œ cloneìœ¼ë¡œ ì•ˆì • ì¬ìƒ
        const a = new Audio(SFX_TICK_SRC);
        a.volume = 1.0;
        a.currentTime = 0;
        a.play().catch(()=>{});
      } catch(e) {}
    }

    // ===== ë…¸íŠ¸/í¼í™íŠ¸ ì´ë¯¸ì§€ =====
    const imgNote = new Image();
    imgNote.crossOrigin = "anonymous";
    imgNote.src = "assets/note.png";

    const imgPerfect = new Image();
    imgPerfect.crossOrigin = "anonymous";
    imgPerfect.src = "assets/perfect.png";

    // ===== ë°°ê²½(ë„ì‹œ ë ˆì´ì–´) =====
    const bgSky = new Image();   bgSky.src = "assets/bg_city_sky.png";
    const bgFar = new Image();   bgFar.src = "assets/bg_city_far.png";
    const bgNear = new Image();  bgNear.src = "assets/bg_city_near.png";
    const bgBlack = new Image(); bgBlack.src = "assets/bg_city_black.png";

    let bgX1 = 0, bgX2 = 0, bgX3 = 0, bgX4 = 0;
    const bgSpeed1 = 8;
    const bgSpeed2 = 18;
    const bgSpeed3 = 30;
    const bgSpeed4 = 42;

    // ===== ë·° =====
    const view = { cssW:0, cssH:0, dpr:1, scale:1, offsetX:0, offsetY:0 };

    // ===== ì¹´ìš´íŠ¸ë‹¤ìš´ =====
    let isPlaying = false;
    const countdown = {
      active:false,
      startAt:0,
      started:false,
      startShownUntil:0,
      tickStage:0 // 0=ì•„ì§, 1=3 ì¬ìƒë¨, 2=2 ì¬ìƒë¨, 3=1 ì¬ìƒë¨
    };
    const COUNTDOWN_IDLE_MS = 1000;
    const COUNTDOWN_STEP_MS = 1000;
    const START_FLASH_MS = 650;

    // ===== ë¦¬ìŠ¤ë„ˆ ê´€ë¦¬(ì¤‘ë³µ ë°©ì§€) =====
    let resizeBound = false;
    function attachResizeOnce() {
      if (resizeBound) return;
      resizeBound = true;
      window.addEventListener("resize", resizeCanvas);
      window.addEventListener("orientationchange", () => setTimeout(resizeCanvas, 50));
    }

    function detachCanvasListeners() {
      if (!gameArea) return;
      gameArea.removeEventListener("pointerdown", onPointerDown);
      gameArea.removeEventListener("pointermove", onPointerMove);
    }
    function attachCanvasListeners() {
      if (!gameArea) return;
      gameArea.addEventListener("pointerdown", onPointerDown, { passive: true });
      gameArea.addEventListener("pointermove", onPointerMove, { passive: true });
    }

    // í‚¤ë³´ë“œëŠ” ë¬¸ì„œ 1íšŒë§Œ(ì¤‘ë³µ ë°©ì§€)
    let keyBound = false;
    function attachKeyOnce() {
      if (keyBound) return;
      keyBound = true;
      document.addEventListener("keydown", onKeyDown, { passive: true });
    }

    function startCountdown() {
      stopAllTimers();
      circles = [];
      prePerfectRings = [];
      score = 0;
      const scoreEl = document.getElementById("score");
      if (scoreEl) scoreEl.innerText = "0";

      isPlaying = false;

      countdown.active = true;
      countdown.startAt = performance.now();
      countdown.started = false;
      countdown.startShownUntil = 0;
      countdown.tickStage = 0;

      if (bgm) { try { bgm.pause(); bgm.currentTime = 0; } catch(e) {} }
      if (sfxTick) { try { sfxTick.pause(); sfxTick.currentTime = 0; } catch(e) {} }
    }

    // ====== ë¦¬ì‚¬ì´ì¦ˆ & ìŠ¤ì¼€ì¼ë§ ======
    function resizeCanvas() {
      if (!gameArea || !ctx) return;

      const container = gameArea.parentElement;
      const containerW = container.clientWidth;

      const aspect = DESIGN_H / DESIGN_W;
      let cssW = containerW;
      let cssH = Math.round(cssW * aspect);

      const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
      const maxH = (window.innerWidth < 768) ? Math.round(vh * 0.85) : Math.round(vh * 0.80);
      if (cssH > maxH) { cssH = maxH; cssW = Math.round(cssH / aspect); }

      view.cssW = cssW; view.cssH = cssH;

      const dpr = window.devicePixelRatio || 1;
      view.dpr = dpr;
      gameArea.style.width = cssW + "px";
      gameArea.style.height = cssH + "px";
      gameArea.width = Math.round(cssW * dpr);
      gameArea.height = Math.round(cssH * dpr);

      const scaleX = cssW / DESIGN_W;
      const scaleY = cssH / DESIGN_H;
      view.scale = Math.min(scaleX, scaleY);
      view.offsetX = (cssW - DESIGN_W * view.scale) / 2;
      view.offsetY = (cssH - DESIGN_H * view.scale) / 2;

      applyViewTransform();
    }

    function applyViewTransform() {
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.setTransform(view.scale * view.dpr, 0, 0, view.scale * view.dpr,
                       view.offsetX * view.dpr, view.offsetY * view.dpr);
    }

    function clearFrame() {
      ctx.save();
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, gameArea.width, gameArea.height);
      ctx.restore();
      applyViewTransform();
    }

    // ====== ê³µìš© íŒì • ì²˜ë¦¬ ======
    function judgeRadius(r) {
      if (r > PERFECT_MIN && r < PERFECT_MAX) return 100;
      if (Math.abs(r - TARGET) < 25) return 50;
      return 10;
    }

    function attemptHitOn(index) {
      if (index < 0 || index >= circles.length) return;
      const c = circles[index];
      score += judgeRadius(c.radius);
      const scoreEl = document.getElementById("score");
      if (scoreEl) scoreEl.innerText = score;
      circles.splice(index, 1);
    }

    // ====== ì…ë ¥: í‚¤ë³´ë“œ ======
    function onKeyDown(e) {
      if (devMode) {
        if (e.key.toLowerCase() === "k") showGhost = !showGhost;
        return;
      }
      if (e.code !== "Space") return;
      if (!isPlaying) return;
      if (circles.length === 0) return;
      attemptHitOn(0);
    }

    // ====== ì…ë ¥: í„°ì¹˜/í´ë¦­ ======
    function screenToLogical(clientX, clientY) {
      const rect = gameArea.getBoundingClientRect();
      const cssX = clientX - rect.left;
      const cssY = clientY - rect.top;
      const x = (cssX - view.offsetX) / view.scale;
      const y = (cssY - view.offsetY) / view.scale;
      return { x, y };
    }

    function onPointerMove(e) {
      if (!devMode) return;
      const { x, y } = screenToLogical(e.clientX, e.clientY);
      mouse.x = x; mouse.y = y;
    }

    function onPointerDown(e) {
      const { x, y } = screenToLogical(e.clientX, e.clientY);

      if (devMode) {
        if (!showGhost) return;
        placements.push({ x: Math.round(x), y: Math.round(y), t: 999 });
        sortPlacements();
        renderPlacementList();
        return;
      }

      if (!isPlaying) return;

      let bestIdx = -1;
      let bestDist = Infinity;
      circles.forEach((c, i) => {
        const dist = Math.hypot(x - c.x, y - c.y);
        if (dist <= TOUCH_HIT_RADIUS && dist < bestDist) {
          bestDist = dist;
          bestIdx = i;
        }
      });
      if (bestIdx !== -1) attemptHitOn(bestIdx);
    }

    // ====== ë°°ê²½ ê·¸ë¦¬ê¸°(ì˜¤ë¥¸ìª½ ì´ë™) ======
    function drawScrollingLayer(img, xOffset, speedPxPerSec, dtSec) {
      if (!img || !img.complete || img.naturalWidth === 0) return xOffset;

      xOffset += speedPxPerSec * dtSec;

      const w = DESIGN_W;
      const h = DESIGN_H;

      const imgAspect = img.naturalWidth / img.naturalHeight;
      const drawH = h;
      const drawW = drawH * imgAspect;

      let x = -(xOffset % drawW);
      while (x < w) {
        ctx.drawImage(img, x, 0, drawW, drawH);
        x += drawW;
      }
      return xOffset;
    }

    // ====== ê²Œì„ ë£¨í”„ ======
    function updateGame(now) {
      if (!lastFrameAt) lastFrameAt = now;
      const dtSec = Math.min(0.05, (now - lastFrameAt) / 1000);
      lastFrameAt = now;

      clearFrame();

      // ë°°ê²½
      bgX1 = drawScrollingLayer(bgSky,  bgX1, bgSpeed1, dtSec);
      bgX2 = drawScrollingLayer(bgFar,  bgX2, bgSpeed2, dtSec);
      bgX3 = drawScrollingLayer(bgNear, bgX3, bgSpeed3, dtSec);
      bgX4 = drawScrollingLayer(bgBlack,bgX4, bgSpeed4, dtSec);

      // ===== ê²Œì„ëª¨ë“œ: í¼í™íŠ¸ ë§ë§Œ 0.5ì´ˆ ë¨¼ì € í‘œì‹œ =====
      if (!devMode) {
        prePerfectRings = prePerfectRings.filter(r => r.until > now);

        if (prePerfectRings.length) {
          ctx.save();
          ctx.globalAlpha = 0.35;

          if (imgPerfect.complete && imgPerfect.naturalWidth > 0) {
            const sizeP = TARGET * 2;
            for (const r of prePerfectRings) {
              ctx.drawImage(imgPerfect, r.x - TARGET, r.y - TARGET, sizeP, sizeP);
            }
          } else {
            ctx.strokeStyle = "white";
            ctx.setLineDash([10 / view.scale, 8 / view.scale]);
            for (const r of prePerfectRings) {
              ctx.beginPath();
              ctx.arc(r.x, r.y, TARGET, 0, Math.PI * 2);
              ctx.stroke();
            }
          }

          ctx.restore();
        }
      }

      // ===== ë°°ì¹˜ëª¨ë“œ: ë°°ì¹˜ëœ ì¤‘ì‹¬ ì  + í¼í™íŠ¸ ë§ ë°˜íˆ¬ëª… =====
      if (devMode) {
        ctx.save();
        ctx.fillStyle = "rgba(255,255,255,0.75)";
        for (const p of placements) {
          ctx.beginPath();
          ctx.arc(p.x, p.y, 2.2, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.restore();

        ctx.save();
        ctx.globalAlpha = 0.22;
        if (imgPerfect.complete && imgPerfect.naturalWidth > 0) {
          const sizeP = TARGET * 2;
          for (const p of placements) {
            ctx.drawImage(imgPerfect, p.x - TARGET, p.y - TARGET, sizeP, sizeP);
          }
        } else {
          ctx.strokeStyle = "white";
          ctx.setLineDash([10 / view.scale, 8 / view.scale]);
          for (const p of placements) {
            ctx.beginPath();
            ctx.arc(p.x, p.y, TARGET, 0, Math.PI * 2);
            ctx.stroke();
          }
        }
        ctx.restore();
      }

      // ===== ì¹´ìš´íŠ¸ë‹¤ìš´(ê²Œì„ ëª¨ë“œ) + 3/2/1ì— ë§ì¶° í‹± ì¬ìƒ =====
      if (!devMode && countdown.active) {
        const t = now - countdown.startAt;

        // 3~1 êµ¬ê°„ì—ì„œ 1ì´ˆë§ˆë‹¤ ì •í™•íˆ 1ë²ˆì”© í‹±
        if (t >= COUNTDOWN_IDLE_MS && t < COUNTDOWN_IDLE_MS + 3 * COUNTDOWN_STEP_MS) {
          const phase = t - COUNTDOWN_IDLE_MS;              // 0~2999...
          const stage = Math.floor(phase / COUNTDOWN_STEP_MS); // 0(3),1(2),2(1)
          while (countdown.tickStage <= stage && countdown.tickStage < 3) {
            playTick();
            countdown.tickStage++;
          }
        }

        let text = "";
        if (t < COUNTDOWN_IDLE_MS) {
          text = "";
        } else if (t < COUNTDOWN_IDLE_MS + 1 * COUNTDOWN_STEP_MS) {
          text = "3";
        } else if (t < COUNTDOWN_IDLE_MS + 2 * COUNTDOWN_STEP_MS) {
          text = "2";
        } else if (t < COUNTDOWN_IDLE_MS + 3 * COUNTDOWN_STEP_MS) {
          text = "1";
        } else {
          if (!countdown.started) {
            countdown.started = true;
            countdown.startShownUntil = now + START_FLASH_MS;

            // START ìˆœê°„: ì§„ì§œ ê²Œì„ ì‹œì‘(ìŠ¤ì¼€ì¤„ + BGM)
            isPlaying = true;
            gameStartAt = performance.now();
            lastFrameAt = now;

            stopAllTimers();
            schedulePlacements();

            try {
              if (bgm) {
                bgm.currentTime = 0;
                bgm.volume = 0.5;
                bgm.play().catch(()=>{});
              }
            } catch(e) {}
          }
          if (now < countdown.startShownUntil) text = "START";
          else countdown.active = false;
        }

        if (text) {
          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillStyle = "rgba(255,255,255,0.95)";
          ctx.shadowColor = "rgba(0,0,0,0.65)";
          ctx.shadowBlur = 14;
          ctx.font = "900 140px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
          ctx.fillText(text, CENTER_X(), CENTER_Y());
          ctx.restore();
        }
      }

      // ìš°ì¸¡ ìƒë‹¨ í”Œë ˆì´íƒ€ì„(í”Œë ˆì´ ì¤‘ì—ë§Œ)
      if (!devMode && isPlaying) {
        ctx.save();
        ctx.setLineDash([]);
        ctx.fillStyle = "white";
        ctx.textAlign = "right";
        ctx.textBaseline = "top";
        ctx.font = `${Math.max(12, Math.floor(14 / view.scale))}px sans-serif`;
        const tSec = (getPlayTimeMs() / 1000).toFixed(2);
        ctx.fillText(`t=${tSec}s`, DESIGN_W - 8, 8);
        ctx.restore();
      }

      // ë…¸íŠ¸ ì—…ë°ì´íŠ¸/ê·¸ë¦¬ê¸°
      const grow = GROW_PER_SEC * dtSec;

      circles.forEach(c => {
        c.radius += grow;

        // ë…¸íŠ¸ ì´ë¯¸ì§€
        if (imgNote.complete && imgNote.naturalWidth > 0) {
          const size = c.radius * 2;
          ctx.drawImage(imgNote, c.x - c.radius, c.y - c.radius, size, size);
        } else {
          ctx.beginPath();
          ctx.strokeStyle = "#bfffbf";
          ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
          ctx.stroke();
        }

        // í¼í™íŠ¸ ê¸°ì¤€ ë§(ê¸°ì¡´)
        if (imgPerfect.complete && imgPerfect.naturalWidth > 0) {
          const sizeP = TARGET * 2;
          ctx.drawImage(imgPerfect, c.x - TARGET, c.y - TARGET, sizeP, sizeP);
        } else {
          ctx.save();
          ctx.setLineDash([10 / view.scale, 7 / view.scale]);
          ctx.strokeStyle = "red";
          ctx.beginPath();
          ctx.arc(c.x, c.y, TARGET, 0, Math.PI * 2);
          ctx.stroke();
          ctx.restore();
        }
      });

      circles = circles.filter(c => c.radius <= 85);

      // ë°°ì¹˜ëª¨ë“œ ê³ ìŠ¤íŠ¸
      if (devMode && showGhost && imgNote.complete && imgNote.naturalWidth > 0) {
        const r = 12;
        ctx.globalAlpha = 0.8;
        ctx.drawImage(imgNote, mouse.x - r, mouse.y - r, r*2, r*2);
        ctx.globalAlpha = 1;
      }

      requestAnimationFrame(updateGame);
    }

    // ====== í™”ë©´ êµ¬ì„± ======
    function startGame() {
      unlockScroll();
      devMode = false;
      isPlaying = false;
      countdown.active = false;

      stopAllTimers();
      circles = [];
      prePerfectRings = [];

      document.getElementById("content").innerHTML = `
        <div class="input-row">
          <label for="studentId">í•™ë²ˆ</label>
          <input id="studentId" type="text" placeholder="ì˜ˆ) 30123">
        </div>
        <div class="input-row">
          <label for="name">ì´ë¦„</label>
          <input id="name" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="bar">
          <button onclick="gameStart()">ì…ë ¥ ì™„ë£Œ</button>
        </div>
      `;
    }

    function gameStart() {
      lockScroll();

      const id = (document.getElementById("studentId").value || "").trim();
      const name = (document.getElementById("name").value || "").trim();

      // ì´ì „ ìº”ë²„ìŠ¤ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
      detachCanvasListeners();

      document.getElementById("content").innerHTML = `
        <canvas id="gameCanvas"></canvas>
        <p>ì ìˆ˜: <span id="score">0</span></p>
        <p>${id} ${name} ë‹˜, (ëª¨ë°”ì¼: í„°ì¹˜ / PC: Space)</p>
      `;

      gameArea = document.getElementById("gameCanvas");
      ctx = gameArea.getContext("2d");

      resizeCanvas();
      attachCanvasListeners();
      attachResizeOnce();
      attachKeyOnce();

      // âœ… ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘(3/2/1 í‹± / START ìˆœê°„ BGM)
      primeBgm();
      primeTick();
      startCountdown();

      lastFrameAt = 0;
      requestAnimationFrame(updateGame);
    }

    function showRanking() {
      unlockScroll();
      devMode = false;
      isPlaying = false;
      countdown.active = false;

      stopAllTimers();
      circles = [];
      prePerfectRings = [];

      if (bgm) { try { bgm.pause(); } catch(e) {} }

      document.getElementById("content").innerHTML = `<p>ë­í‚¹ ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •</p>`;
    }

    // ====== ë°ì´í„° / API ======
    function createCircle(x = CENTER_X(), y = CENTER_Y()) {
      // ê°™ì€ ì¢Œí‘œì— â€œë¯¸ë¦¬ ë§â€ì´ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€ë¡œ ì œê±°
      removePrePerfectRingAt(x, y);
      circles.push({ x, y, radius: NOTE_START_R });
    }
    window.createCircle = createCircle;

    // ====== ë°°ì¹˜ ëª¨ë“œ ======
    function enterPlacementMode() {
      lockScroll();
      devMode = true;
      isPlaying = false;
      countdown.active = false;

      stopAllTimers();
      circles = [];
      prePerfectRings = [];

      if (bgm) { try { bgm.pause(); bgm.currentTime = 0; } catch(e) {} }

      // ì´ì „ ìº”ë²„ìŠ¤ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
      detachCanvasListeners();

      document.getElementById("content").innerHTML = `
        <div class="dev-wrap">
          <div class="canvas-col">
            <canvas id="gameCanvas"></canvas>
            <p class="hint">
              ë°°ì¹˜ ëª¨ë“œ: <b>K</b> ë¥¼ ëˆ„ë¥´ë©´ ê³ ìŠ¤íŠ¸ê°€ ë”°ë¼ì˜µë‹ˆë‹¤. ê³ ìŠ¤íŠ¸ê°€ ì¼œì§„ ìƒíƒœì—ì„œ <b>í´ë¦­</b>í•˜ë©´ ë°°ì¹˜ë©ë‹ˆë‹¤.<br>
              ë¼ì¸ í¸ì§‘ ì‹œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤. ì˜ˆ) <code>setTimeout(() => createCircle(CENTER_X(), CENTER_Y()), beatToMs(6.5));</code><br>
              <small style="color:#aaa;">â€» ê´„í˜¸ ì•ˆ ìˆ«ì(6.5)ê°€ "ë°•ì(beat)" ì…ë‹ˆë‹¤. (BPM=${BPM})</small>
            </p>
          </div>
          <div class="panel-col">
            <h2>ì½”ë“œ ëª©ë¡</h2>
            <small>tëŠ” ë°•ì(beat) ê¸°ì¤€. ê¸°ë³¸ê°’ 999. (ê´„í˜¸ ì•ˆ ìˆ«ìë§Œ ìˆ˜ì •)</small>
            <textarea id="placementText"></textarea>
            <div class="bar" style="margin-top:10px;">
              <button onclick="applyPlacementText()">ì ìš©</button>
              <button onclick="clearPlacements()">ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>
      `;

      gameArea = document.getElementById("gameCanvas");
      ctx = gameArea.getContext("2d");

      resizeCanvas();
      attachCanvasListeners();
      attachResizeOnce();
      attachKeyOnce();

      mouse.x = CENTER_X();
      mouse.y = CENTER_Y();
      showGhost = false;

      renderPlacementList();

      lastFrameAt = 0;
      requestAnimationFrame(updateGame);
    }

    function renderPlacementList() {
      const ta = document.getElementById("placementText");
      if (!ta) return;
      const lines = placements.map(p =>
        `setTimeout(() => createCircle(${p.x}, ${p.y}), beatToMs(${formatBeat(p.t)}));`
      );
      ta.value = lines.join("\n");
    }

    function parsePlacementText(text) {
      const out = [];
      const re = /setTimeout\(\(\)\s*=>\s*createCircle\(\s*(-?\d+)\s*,\s*(-?\d+)\s*\)\s*,\s*(?:beatToMs\(\s*)?(\d+(?:\.\d+)?)\s*\)?\s*\)\s*;/g;
      let m;
      while ((m = re.exec(text)) !== null) {
        out.push({ x: Number(m[1]), y: Number(m[2]), t: Number(m[3]) });
      }
      return out;
    }

    function sortPlacements() {
      placements.sort((a,b) => a.t - b.t);
    }

    function applyPlacementText() {
      const ta = document.getElementById("placementText");
      if (!ta) return;
      placements = parsePlacementText(ta.value);
      sortPlacements();
      renderPlacementList();
    }

    function clearPlacements() {
      placements = [];
      renderPlacementList();
    }

    // ====== ìŠ¤ì¼€ì¤„ ======
    function stopAllTimers() {
      activeTimers.forEach(id => clearTimeout(id));
      activeTimers = [];
    }

    function schedulePlacements() {
      // tëŠ” "í¼í™íŠ¸ ì¤‘ì‹¬(TARGET)ì´ ë˜ëŠ” ì‹œì "ì˜ ë°•ì(beat)
      const leadMs = ((TARGET - NOTE_START_R) / GROW_PER_SEC) * 1000;

      placements.forEach(p => {
        const perfectMs = beatToMs(p.t);
        const spawnDelay = Math.max(0, perfectMs - leadMs);

        // âœ… í¼í™íŠ¸ ë§ë§Œ 0.5ì´ˆ ë¨¼ì €
        const ringDelay = Math.max(0, spawnDelay - PRE_RING_MS);
        const idRing = setTimeout(() => addPrePerfectRing(p.x, p.y), ringDelay);
        activeTimers.push(idRing);

        // ë…¸íŠ¸(ì›)
        const id = setTimeout(() => createCircle(p.x, p.y), spawnDelay);
        activeTimers.push(id);
      });
    }

    // ì²« ì§„ì…
    startGame();
  </script>
</body>
</html>
